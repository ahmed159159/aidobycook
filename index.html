<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dobby Cooking Assistant ‚Äî HTML (Dobby engine)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      /* fallback background color */
      background: #fffaf0;
      color: #222;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .container-centered { max-width: 1100px; margin: 0 auto; }
    header { display:flex; align-items:center; gap:16px; margin-bottom: 8px; }
    header img.logo { width:64px; height:64px; border-radius:50%; object-fit:cover; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    h1 { font-size: 1.5rem; margin:0; }
    .small-muted { font-size:0.9rem; color:#666; margin-bottom:12px; }
    .card-result { margin-top:12px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); padding:12px; background:white; }
    .recipe-img { max-width:100%; height:auto; border-radius:12px; display:block; margin-bottom:12px; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .status { margin-top:8px; }
    .hidden { display:none !important; }
    .spinner-inline { display:inline-block; width:18px; height:18px; border-radius:50%; border:3px solid rgba(0,0,0,0.12); border-top-color:#ff6b00; animation: spin 1s linear infinite; vertical-align:middle; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    footer.small-muted { margin-top:18px; color:#888; font-size:0.85rem; }
  </style>
</head>
<body>
  <div class="container-centered">
    <header>
      <!-- Put logo.png in same folder as index.html -->
      <img src="logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <div>
        <h1>Dobby Cooking Assistant</h1>
        <div class="small-muted">Type ingredients or ask for a dish. Example: "I have potatoes and 250g beef, what can I cook?"</div>
      </div>
    </header>

    <div class="card card-body">
      <div class="mb-3">
        <label for="userText" class="form-label">Your question or ingredients</label>
        <input id="userText" class="form-control" placeholder="e.g. potatoes, beef, garlic" />
      </div>

      <div class="controls">
        <button id="askBtn" class="btn btn-primary">Ask Dobby</button>
        <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>

        <!-- Only visible setting user asked to keep -->
        <div style="min-width:160px;">
          <label class="form-label mb-0">Results (max recipes)</label>
          <input id="maxResults" type="number" min="1" max="8" class="form-control" value="3" />
        </div>

        <div id="status" class="status"></div>
      </div>

      <div id="chatArea" style="margin-top:12px;"></div>
    </div>

    <footer class="small-muted">
      Notes: The first time it is used, it may take a minute or two to show results, but after that, it works normally.

    </footer>
  </div>

<script>
/* ----------------------------- CONFIG (embedded keys) -----------------------------
  You requested keys embedded. Keep this file private if you don't want keys public.
  Replace values or leave as-is. */
const FIREWORKS_API_KEY = "fw_3ZP4FeSXSHPLqciG2exufxtL"; // your Fireworks key
const FIREWORKS_MODEL = "accounts/ahmed159/deployedModels/dobby-unhinged-llama-3-3-70b-new-vdw6j81e";
const FIREWORKS_URL = "https://api.fireworks.ai/inference/v1/chat/completions";

const SPOONACULAR_API_KEY = "803bffd94314410886102ebcc075ddad";
const SPOON_BASE = "https://api.spoonacular.com";
/* ------------------------------------------------------------------------------- */

/* ANALYSIS PROMPT ‚Äî same as Python version */
const ANALYSIS_SYSTEM_PROMPT = `
You are Dobby, a friendly cooking assistant. Your job: analyze the user's message and return ONLY a compact JSON object (no other text) with the following fields:

- intent: one of "find_recipe", "specific_recipe", or "modify_recipe" or "general"
- ingredients: an array of ingredient words (lowercase) if present (or empty array)
- dish: a short dish name if user requested a specific recipe (or null)
- exclude: an array of ingredients to exclude (if user explicitly asked to avoid something)
- message: a short English sentence summarizing interpretation (for user display)

If the user asks something not about cooking, return {"intent":"general","message":"...","ingredients":[], "dish": null, "exclude": []}

Return JSON only, nothing else.
`;

/* ----------------------------- Helpers ----------------------------- */
function el(id){ return document.getElementById(id); }
function setStatus(html, type='info'){
  const s = el('status');
  if(!html) { s.innerHTML = ''; return; }
  s.innerHTML = `<div style="display:inline-flex;align-items:center;gap:8px"><span class="spinner-inline"></span><span>${html}</span></div>`;
}
function appendCard(html, isUser=false){
  const area = el('chatArea');
  const card = document.createElement('div');
  card.className = 'card-result';
  if(isUser) card.style.background = '#eef7ff';
  card.innerHTML = isUser ? `<strong>You:</strong> ${escapeHtml(html)}` : html;
  area.insertBefore(card, area.firstChild);
}
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function cleanModelJsonResponse(raw){
  if(!raw) return raw;
  let cleaned = raw.trim();
  if(cleaned.startsWith('```')) {
    cleaned = cleaned.split('```').slice(1).join('```').trim();
  }
  const first = cleaned.indexOf('{');
  const last = cleaned.lastIndexOf('}');
  if(first !== -1 && last !== -1 && last > first) return cleaned.substring(first, last+1);
  return cleaned;
}

/* -------------------- Fireworks call (Dobby) -------------------- */
async function callFireworksChat(systemPrompt, userPrompt, max_tokens=512, temperature=0.2){
  if(!FIREWORKS_API_KEY) throw new Error('FIREWORKS_API_KEY not set.');
  const payload = {
    model: FIREWORKS_MODEL,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    max_tokens, temperature
  };
  const res = await fetch(FIREWORKS_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'Authorization': `Bearer ${FIREWORKS_API_KEY}`
    },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`Fireworks API error ${res.status}: ${t}`);
  }
  const j = await res.json();
  // try choices[0].message.content or choices[0].text
  if(j.choices && j.choices.length>0){
    const choice = j.choices[0];
    if(choice.message && choice.message.content) return choice.message.content;
    if(choice.text) return choice.text;
  }
  throw new Error('Fireworks returned no text');
}

/* -------------------- Spoonacular wrappers -------------------- */
async function spoonSearchByIngredients(ingredients, exclude=[], number=3){
  if(!SPOONACULAR_API_KEY) throw new Error('SPOONACULAR_API_KEY not set.');
  const ing_csv = ingredients.map(i => i.replace(/\s+/g,'+')).join(',');
  const params = new URLSearchParams({
    ingredients: ing_csv,
    number: String(number),
    ranking: '1',
    ignorePantry: 'true',
    apiKey: SPOONACULAR_API_KEY
  });
  if(exclude && exclude.length) params.set('excludeIngredients', exclude.join(','));
  const url = `${SPOON_BASE}/recipes/findByIngredients?${params.toString()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Spoonacular search error ${res.status}: ${await res.text()}`);
  return res.json(); // returns array
}

async function spoonSearchByQuery(query, number=3){
  if(!SPOONACULAR_API_KEY) throw new Error('SPOONACULAR_API_KEY not set.');
  const params = new URLSearchParams({ query, number: String(number), apiKey: SPOONACULAR_API_KEY });
  const url = `${SPOON_BASE}/recipes/complexSearch?${params.toString()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Spoonacular search error ${res.status}: ${await res.text()}`);
  const data = await res.json();
  return data.results || [];
}

async function spoonGetRecipeInformation(recipeId){
  if(!SPOONACULAR_API_KEY) throw new Error('SPOONACULAR_API_KEY not set.');
  const params = new URLSearchParams({ apiKey: SPOONACULAR_API_KEY, includeNutrition: 'false' });
  const url = `${SPOON_BASE}/recipes/${recipeId}/information?${params.toString()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Spoonacular info error ${res.status}: ${await res.text()}`);
  return res.json();
}

/* -------------------- Format recipe for display -------------------- */
function formatRecipeHtml(info){
  const title = info.title || 'Recipe';
  let html = `<h4>${escapeHtml(title)}</h4>`;
  if(info.readyInMinutes) html += `<div>‚è± Ready in: ${info.readyInMinutes} minutes</div>`;
  if(info.servings) html += `<div>üçΩ Serves: ${info.servings}</div>`;
  if(info.image) html += `<img class="recipe-img" src="${info.image}" alt="${escapeHtml(title)}">`;
  html += '<h6>Ingredients:</h6><ul>';
  (info.extendedIngredients || []).forEach(ing => {
    const amt = ing.originalString || `${ing.amount||''} ${ing.unit||''} ${ing.name||''}`;
    html += `<li>${escapeHtml(amt)}</li>`;
  });
  html += '</ul>';
  // steps
  const steps = [];
  const ai = info.analyzedInstructions || [];
  if(Array.isArray(ai)){
    ai.forEach(sec => { (sec.steps||[]).forEach(s => steps.push(s.step)); });
  }
  if(steps.length === 0 && info.instructions){
    info.instructions.split('. ').forEach(s => { if(s.trim()) steps.push(s.trim()); });
  }
  if(steps.length){
    html += '<h6>Steps:</h6><ol>';
    steps.forEach(s => html += `<li>${escapeHtml(s)}</li>`);
    html += '</ol>';
  }
  if(info.sourceUrl) html += `<div>üîó Source: <a href="${info.sourceUrl}" target="_blank">link</a></div>`;
  return html;
}

/* -------------------- Main logic: analyze -> search -> show -------------------- */
async function analyzeUserText(userText){
  // call Dobby to get compact JSON result
  const raw = await callFireworksChat(ANALYSIS_SYSTEM_PROMPT, userText, 256, 0.2);
  const jsonText = cleanModelJsonResponse(raw);
  try {
    const parsed = JSON.parse(jsonText);
    parsed.ingredients = parsed.ingredients || [];
    parsed.exclude = parsed.exclude || [];
    parsed.dish = (parsed.dish === undefined) ? null : parsed.dish;
    parsed.message = parsed.message || '';
    parsed.intent = parsed.intent || 'find_recipe';
    return parsed;
  } catch(e){
    // fallback: treat whole text as ingredients search
    return { intent: 'find_recipe', ingredients: [userText], dish: null, exclude: [], message: `Searching for recipes based on: ${userText}` };
  }
}

async function onAsk(){
  const userText = el('userText').value.trim();
  if(!userText) return;
  appendCard(userText, true);
  setStatus('Dobby is thinking...');
  try {
    const parsed = await analyzeUserText(userText);
    setStatus(''); // clear
    appendCard(`<strong>Dobby:</strong> ${escapeHtml(parsed.message || 'I will search for recipes.')}`);
    const intent = parsed.intent;
    const ingredients = parsed.ingredients || [];
    const exclude = parsed.exclude || [];
    const dish = parsed.dish || null;
    const maxResults = parseInt(el('maxResults').value, 10) || 3;

    let recipes_meta = [];
    if(['find_recipe','modify_recipe'].includes(intent)){
      if(ingredients && ingredients.length > 0){
        // use findByIngredients
        const results = await spoonSearchByIngredients(ingredients, exclude, maxResults);
        // results is array of recipe objects
        results.forEach(r => recipes_meta.push({ id: r.id, title: r.title, image: r.image }));
      } else {
        const q = dish || userText;
        const results = await spoonSearchByQuery(q, maxResults);
        results.forEach(r => recipes_meta.push({ id: r.id, title: r.title, image: r.image }));
      }
    } else if(intent === 'specific_recipe'){
      const q = dish || userText;
      const results = await spoonSearchByQuery(q, 1);
      results.forEach(r => recipes_meta.push({ id: r.id, title: r.title, image: r.image }));
    } else {
      // general intent -> ask Dobby to answer directly
      setStatus('Dobby is answering...');
      const answer = await callFireworksChat("You are Dobby, a helpful cooking assistant.", userText, 300, 0.2);
      setStatus('');
      appendCard(`<div>${escapeHtml(answer)}</div>`);
    }

    // fetch details for each recipe and show
    for(const meta of recipes_meta){
      try {
        const info = await spoonGetRecipeInformation(meta.id);
        const html = formatRecipeHtml(info);
        appendCard(html, false);
      } catch (err) {
        appendCard(`<div style="color:#b00">Could not fetch details for ${escapeHtml(meta.title||'')} : ${escapeHtml(err.message||String(err))}</div>`);
      }
    }

  } catch(err) {
    setStatus('');
    appendCard(`<div style="color:#b00">Error: ${escapeHtml(err.message || String(err))}</div>`);
  }
}

/* UI wiring */
el('askBtn').addEventListener('click', onAsk);
el('clearBtn').addEventListener('click', () => { el('chatArea').innerHTML = ''; setStatus(''); });

/* Keyboard: Enter to ask when focus in input */
el('userText').addEventListener('keydown', (e) => {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    onAsk();
  }
});
</script>
</body>
</html>
