<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dobby Cooking Assistant ‚Äî Full</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 18px; background: #fffaf0; color: #222; }
    .sidebar { border-left: 1px solid #eee; min-height: 80vh; }
    .recipe-img { max-width: 100%; height: auto; display:block; margin-bottom:8px }
    pre { white-space: pre-wrap; }
    .card-user { background:#eef7ff; }
    .card-dobby { background:#fff6e6; }
    .small-muted { font-size: 0.9rem; color:#666; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Main column -->
      <div class="col-md-8">
        <h1>üç≥ Dobby Cooking Assistant ‚Äî Full</h1>
        <p class="small-muted">Type ingredients or ask for a dish. Example: <em>"I have potatoes and 250g beef, what can I cook?"</em></p>

        <div class="mb-3">
          <label for="userText" class="form-label">Your question or ingredients</label>
          <input id="userText" class="form-control" placeholder="e.g. potatoes, beef" />
        </div>

        <div class="mb-3 d-flex gap-2">
          <button id="askBtn" class="btn btn-primary">Ask Dobby</button>
          <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
        </div>

        <div id="status" class="mb-3"></div>

        <div id="chatArea" aria-live="polite"></div>
      </div>

      <!-- Sidebar -->
      <div class="col-md-4 sidebar">
        <h5>Settings</h5>

        <div class="mb-2">
          <label class="form-label">Fireworks API Key (embedded)</label>
          <input id="fireworksKey" class="form-control" />
        </div>

        <div class="mb-2">
          <label class="form-label">Fireworks Model</label>
          <input id="fireworksModel" class="form-control" value="accounts/ahmed159/deployedModels/dobby-unhinged-llama-3-3-70b-new-vdw6j81e" />
        </div>

        <div class="mb-2">
          <label class="form-label">Spoonacular API Key (embedded)</label>
          <input id="spoonKey" class="form-control" />
        </div>

        <div class="mb-2">
          <label class="form-label">Results (max recipes)</label>
          <input id="maxResults" type="number" min="1" max="8" class="form-control" value="3" />
        </div>

        <div class="mb-2">
          <label class="form-label">Dobby temperature (analysis)</label>
          <input id="temp" type="range" min="0" max="1" step="0.01" class="form-range" value="0.2" />
          <div id="tempValue">0.20</div>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="showImages" checked>
          <label class="form-check-label" for="showImages">Show images (if available)</label>
        </div>

        <hr />
        <h6>Env status</h6>
        <ul id="envStatus" class="small-muted"></ul>

        <hr />
        <small class="small-muted">
          Notes:
          <ul>
            <li>This single-file app calls Fireworks and Spoonacular directly from your browser ‚Äî keys are embedded below.</li>
            <li>If you see <strong>CORS</strong> errors, run a tiny proxy or serve this file from a simple HTTP server (e.g., `python -m http.server 8000`).</li>
            <li>Do not share this file while keys are present.</li>
          </ul>
        </small>
      </div>
    </div>
  </div>

<script>
/* -------------------- Embedded API keys (from your message) --------------------
   You asked to embed these keys. Keep this file private.
*/
const EMBED_FIREWORKS_KEY = "fw_3ZP4FeSXSHPLqciG2exufxtL";
const EMBED_SPOON_KEY = "803bffd94314410886102ebcc075ddad";
/* --------------------------------------------------------------------------- */

const FIREWORKS_URL = 'https://api.fireworks.ai/inference/v1/chat/completions';
const SPOON_BASE = 'https://api.spoonacular.com';
const ANALYSIS_SYSTEM_PROMPT = `
You are Dobby, a friendly cooking assistant. Your job: analyze the user's message and return ONLY a compact JSON object (no other text) with the following fields:

- intent: one of "find_recipe", "specific_recipe", or "modify_recipe" or "general"
- ingredients: an array of ingredient words (lowercase) if present (or empty array)
- dish: a short dish name if user requested a specific recipe (or null)
- exclude: an array of ingredients to exclude (if user explicitly asked to avoid something)
- message: a short English sentence summarizing interpretation (for user display)

If the user asks something not about cooking, return {"intent":"general","message":"...","ingredients":[], "dish": null, "exclude": []}

Return JSON only, nothing else.
`;

// Utilities
function showStatus(txt, type='info'){
  const s = document.getElementById('status');
  s.innerHTML = `<div class="alert alert-${type}">${txt}</div>`;
}
function appendCard(html, isUser=false){
  const chat = document.getElementById('chatArea');
  const card = document.createElement('div');
  card.className = 'card mb-2 ' + (isUser ? 'card-user' : 'card-dobby');
  const body = document.createElement('div');
  body.className = 'card-body';
  if(isUser) body.innerHTML = `<strong>You:</strong> ${escapeHtml(html)}`;
  else body.innerHTML = html;
  card.appendChild(body);
  chat.insertBefore(card, chat.firstChild);
}
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/\"/g, "&quot;")
       .replace(/'/g, "&#039;");
}
function cleanModelJsonResponse(raw){
  let cleaned = raw.trim();
  if(cleaned.startsWith('```')){
    cleaned = cleaned.split('```').slice(1).join('```').trim();
  }
  const first = cleaned.indexOf('{');
  const last = cleaned.lastIndexOf('}');
  if(first !== -1 && last !== -1 && last > first){
    return cleaned.substring(first, last+1);
  }
  return cleaned;
}

/* -------------------- Fireworks chat call -------------------- */
async function callFireworksChat(systemPrompt, userPrompt, max_tokens=512, temperature=0.7){
  const key = document.getElementById('fireworksKey').value.trim() || EMBED_FIREWORKS_KEY;
  const model = document.getElementById('fireworksModel').value.trim() || '';
  if(!key) throw new Error('FIREWORKS_API_KEY not set.');
  const payload = {
    model: model || "accounts/ahmed159/deployedModels/dobby-unhinged-llama-3-3-70b-new-vdw6j81e",
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    max_tokens, temperature
  };
  const res = await fetch(FIREWORKS_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`Fireworks API error ${res.status}: ${t}`);
  }
  const j = await res.json();
  if(j.choices && j.choices.length>0){
    const choice = j.choices[0];
    if(choice.message && choice.message.content) return choice.message.content;
    if(choice.text) return choice.text;
  }
  throw new Error('Fireworks returned no text');
}

/* -------------------- Spoonacular wrappers -------------------- */
async function spoonSearchByIngredients(ingredients, exclude=[], number=3){
  const key = document.getElementById('spoonKey').value.trim() || EMBED_SPOON_KEY;
  if(!key) throw new Error('SPOONACULAR_API_KEY not set.');
  const ing_csv = ingredients.map(i => i.replace(/\s+/g,'+')).join(',');
  const params = new URLSearchParams({
    ingredients: ing_csv,
    number: String(number),
    ranking: '1',
    ignorePantry: 'true',
    apiKey: key
  });
  if(exclude && exclude.length) params.set('excludeIngredients', exclude.join(','));
  const url = `${SPOON_BASE}/recipes/findByIngredients?${params.toString()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Spoonacular search error ${res.status}: ${await res.text()}`);
  return res.json();
}

async function spoonSearchByQuery(query, number=3){
  const key = document.getElementById('spoonKey').value.trim() || EMBED_SPOON_KEY;
  if(!key) throw new Error('SPOONACULAR_API_KEY not set.');
  const params = new URLSearchParams({ query, number: String(number), apiKey: key });
  const url = `${SPOON_BASE}/recipes/complexSearch?${params.toString()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Spoonacular search error ${res.status}: ${await res.text()}`);
  const data = await res.json();
  return data.results || [];
}

async function spoonGetRecipeInformation(recipeId){
  const key = document.getElementById('spoonKey').value.trim() || EMBED_SPOON_KEY;
  const params = new URLSearchParams({ apiKey: key, includeNutrition: 'false' });
  const url = `${SPOON_BASE}/recipes/${recipeId}/information?${params.toString()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Spoonacular info error ${res.status}: ${await res.text()}`);
  return res.json();
}

function formatRecipeForChat(info){
  const title = info.title || 'Recipe';
  let out = `<h5>${escapeHtml(title)}</h5>`;
  if(info.readyInMinutes) out += `<div>‚è± Ready in: ${info.readyInMinutes} minutes</div>`;
  if(info.servings) out += `<div>üçΩ Serves: ${info.servings}</div>`;
  out += '<h6>Ingredients:</h6><ul>';
  (info.extendedIngredients||[]).forEach(ing=>{
    const amt = ing.originalString || `${ing.amount||''} ${ing.unit||''} ${ing.name||''}`;
    out += `<li>${escapeHtml(amt)}</li>`;
  });
  out += '</ul>';
  const steps = [];
  const ai = info.analyzedInstructions || [];
  if(Array.isArray(ai)){
    ai.forEach(sec=>{ (sec.steps||[]).forEach(s=> steps.push(s.step)); });
  }
  if(steps.length===0 && info.instructions){
    info.instructions.split('. ').forEach(s=>{ if(s.trim()) steps.push(s.trim()); });
  }
  if(steps.length){
    out += '<h6>Steps:</h6><ol>';
    steps.forEach(s=> out += `<li>${escapeHtml(s)}</li>`);
    out += '</ol>';
  }
  if(info.sourceUrl) out += `<div>üîó Source: <a href="${escapeHtml(info.sourceUrl)}" target="_blank">link</a></div>`;
  return out;
}

/* -------------------- Main flow -------------------- */
async function analyzeUserText(userText){
  const raw = await callFireworksChat(ANALYSIS_SYSTEM_PROMPT, userText, 256, parseFloat(document.getElementById('temp').value));
  const jsonText = cleanModelJsonResponse(raw);
  try{
    const parsed = JSON.parse(jsonText);
    parsed.ingredients = parsed.ingredients || [];
    parsed.exclude = parsed.exclude || [];
    parsed.dish = (parsed.dish===undefined)? null : parsed.dish;
    parsed.message = parsed.message || '';
    parsed.intent = parsed.intent || 'find_recipe';
    return parsed;
  }catch(e){
    return { intent:'find_recipe', ingredients:[userText], dish:null, exclude:[], message:`Searching for recipes based on: ${userText}` };
  }
}

async function onAsk(){
  const userText = document.getElementById('userText').value.trim();
  if(!userText) return;
  appendCard(userText, true);
  showStatus('Dobby is analyzing your request...', 'info');
  try{
    const parsed = await analyzeUserText(userText);
    showStatus('Analysis complete', 'success');
    appendCard(`<strong>Dobby:</strong> ${escapeHtml(parsed.message || 'I will search for recipes.')}`);
    const intent = parsed.intent;
    const ingredients = parsed.ingredients || [];
    const exclude = parsed.exclude || [];
    const dish = parsed.dish || null;
    const maxResults = parseInt(document.getElementById('maxResults').value, 10) || 3;
    let recipes_meta = [];
    if(['find_recipe','modify_recipe'].includes(intent)){
      if(ingredients && ingredients.length>0){
        const results = await spoonSearchByIngredients(ingredients, exclude, maxResults);
        results.forEach(r => recipes_meta.push({ id: r.id, title: r.title, image: r.image }));
      }else{
        const q = dish || userText;
        const results = await spoonSearchByQuery(q, maxResults);
        results.forEach(r => recipes_meta.push({ id: r.id, title: r.title, image: r.image }));
      }
    }else if(intent==='specific_recipe'){
      const q = dish || userText;
      const results = await spoonSearchByQuery(q, 1);
      results.forEach(r => recipes_meta.push({ id: r.id, title: r.title, image: r.image }));
    }else{
      const answer = await callFireworksChat('You are Dobby, a helpful cooking assistant.', userText, 300, parseFloat(document.getElementById('temp').value));
      appendCard(`<div>${escapeHtml(answer)}</div>`);
    }

    for(const meta of recipes_meta){
      try{
        const info = await spoonGetRecipeInformation(meta.id);
        let formatted = formatRecipeForChat(info);
        if(document.getElementById('showImages').checked && meta.image){
          formatted = `<img src="${meta.image}" class="recipe-img"/>` + formatted;
        }
        appendCard(formatted, false);
      }catch(err){
        appendCard(`<div>Could not fetch details for ${escapeHtml(meta.title||'')}: ${escapeHtml(err.message||String(err))}</div>`, false);
      }
    }
  }catch(err){
    showStatus(`Error: ${err.message}`, 'danger');
    appendCard(`<div class="text-danger">Error: ${escapeHtml(err.message)}</div>`, false);
  }
}

/* UI wiring */
document.getElementById('askBtn').addEventListener('click', onAsk);
document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('chatArea').innerHTML=''; showStatus(''); });
const tempRange = document.getElementById('temp');
tempRange.addEventListener('input', ()=> document.getElementById('tempValue').innerText = parseFloat(tempRange.value).toFixed(2));

function updateEnvStatus(){
  const list = document.getElementById('envStatus'); list.innerHTML = '';
  const f = document.getElementById('fireworksKey').value.trim() || EMBED_FIREWORKS_KEY ? 'OK' : 'MISSING';
  const s = document.getElementById('spoonKey').value.trim() || EMBED_SPOON_KEY ? 'OK' : 'MISSING';
  list.innerHTML = `<li>Fireworks key: ${f}</li><li>Spoonacular key: ${s}</li>`;
}
['fireworksKey','spoonKey'].forEach(id=> document.getElementById(id).addEventListener('input', updateEnvStatus));

// prefill embedded keys into inputs (so you can override if you want)
document.getElementById('fireworksKey').value = EMBED_FIREWORKS_KEY;
document.getElementById('spoonKey').value = EMBED_SPOON_KEY;
updateEnvStatus();

</script>
</body>
</html>
